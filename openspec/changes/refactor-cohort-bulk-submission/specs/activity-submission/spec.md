## ADDED Requirements

### Requirement: Evidence-Dependent Credit Calculation
The system SHALL calculate CPD credits for approved submissions only when required evidence has been provided, ensuring compliance integrity.

#### Scenario: Calculate credits for approved submission with evidence
- **WHEN** a submission has TrangThaiDuyet = 'DaDuyet' and the activity requires evidence (YeuCauMinhChung = true) and FileMinhChungUrl is not null
- **THEN** the system calculates credits using the activity's TyLeQuyDoi conversion rate
- **AND** applies the activity's GioToiThieu and GioToiDa limits

#### Scenario: Zero credits for approved submission missing required evidence
- **WHEN** a submission has TrangThaiDuyet = 'DaDuyet' and the activity requires evidence (YeuCauMinhChung = true) but FileMinhChungUrl is null
- **THEN** the system calculates zero credits
- **AND** does not include the submission in the practitioner's compliance total

#### Scenario: Calculate credits for approved submission without evidence requirement
- **WHEN** a submission has TrangThaiDuyet = 'DaDuyet' and the activity does not require evidence (YeuCauMinhChung = false)
- **THEN** the system calculates credits regardless of FileMinhChungUrl value
- **AND** applies normal conversion rules

#### Scenario: Zero credits for non-approved submissions
- **WHEN** a submission has TrangThaiDuyet = 'ChoDuyet' or 'TuChoi' or 'Nhap'
- **THEN** the system calculates zero credits
- **AND** does not count the submission toward compliance totals

#### Scenario: Admin warning when approving submission without required evidence
- **WHEN** a DonVi admin attempts to approve a submission (set TrangThaiDuyet = 'DaDuyet') where the activity requires evidence but FileMinhChungUrl is null
- **THEN** the system displays a validation warning "Hoạt động yêu cầu minh chứng nhưng chưa có tệp đính kèm"
- **AND** prevents approval until evidence is uploaded

### Requirement: Bulk-Created Submission Metadata
The system SHALL track the origin of submissions to distinguish between practitioner-initiated and admin-created submissions for audit and UX purposes.

#### Scenario: NguoiNhap indicates submission creator
- **WHEN** a submission is created via bulk enrollment by a DonVi admin
- **THEN** NguoiNhap is set to the admin's TaiKhoan.MaTaiKhoan
- **AND** not the practitioner's account ID

#### Scenario: Bulk-created submission maintains practitioner tenancy
- **WHEN** the system persists a submission generated by bulk enrollment
- **THEN** the submission's MaDonVi (or equivalent tenancy column) is populated with the practitioner's current unit ID
- **AND** validation rejects attempts to save a null or mismatched MaDonVi to prevent cross-tenant leakage in downstream queries

#### Scenario: Practitioner view shows admin-created indicator
- **WHEN** a practitioner views a submission where NguoiNhap != their own account ID
- **THEN** the UI displays an indicator "Được tạo bởi quản trị viên"
- **AND** provides context that this is a mandatory enrollment

#### Scenario: Admin audit trail for bulk-created submissions
- **WHEN** an admin or auditor reviews a submission
- **THEN** the submission details display the NguoiNhap account name
- **AND** links to the audit log entry for the bulk creation operation (if applicable)

### Requirement: Duplicate Submission Prevention for Bulk Creation
The system SHALL prevent creation of duplicate submissions for the same practitioner and activity combination during bulk enrollment operations.

#### Scenario: Duplicate detection by MaNhanVien and MaDanhMuc
- **WHEN** a bulk creation request includes a practitioner who already has a GhiNhanHoatDong record with the same MaDanhMuc
- **THEN** the system skips creation for that practitioner
- **AND** includes their MaNhanVien in the response's duplicates list

#### Scenario: Duplicate check considers only catalog-linked submissions
- **WHEN** checking for duplicates during bulk creation
- **THEN** the system queries WHERE MaDanhMuc = $catalogId AND MaNhanVien = ANY($practitionerIds)
- **AND** does not consider ad-hoc submissions (MaDanhMuc = null) as duplicates

#### Scenario: Partial success on duplicates
- **WHEN** a bulk creation request includes 10 practitioners, 3 of whom have existing submissions
- **THEN** the system creates 7 new submissions
- **AND** returns success with created: 7, skipped: 3, failed: 0
- **AND** includes the 3 duplicate practitioner IDs in the response

#### Scenario: Idempotent bulk creation
- **WHEN** an admin reruns the same bulk creation request (same activity, same cohort)
- **THEN** the system skips all existing submissions
- **AND** returns success with created: 0, skipped: N, failed: 0
- **AND** no duplicate submissions are created

## MODIFIED Requirements

### Requirement: Practitioner-Initiated Submission Creation
The system SHALL continue to support practitioner-initiated submission creation while coexisting with admin-initiated bulk enrollment workflows.

#### Scenario: Practitioner creates individual submission
- **WHEN** a practitioner (NguoiHanhNghe) creates a submission via the submission form
- **THEN** NguoiNhap is set to their own TaiKhoan.MaTaiKhoan
- **AND** MaNhanVien is automatically populated from their account link
- **AND** the submission follows the existing validation and approval workflow

#### Scenario: Practitioner cannot create duplicate catalog submission
- **WHEN** a practitioner attempts to create a submission for an activity catalog entry they already have a submission for
- **THEN** the system displays a validation error "Bạn đã có bản ghi cho hoạt động này"
- **AND** suggests editing the existing submission instead

#### Scenario: DonVi admin creates submission on behalf of practitioner
- **WHEN** a DonVi admin uses the submission form with practitioner selector
- **THEN** NguoiNhap is set to the admin's account ID
- **AND** MaNhanVien is set to the selected practitioner
- **AND** the submission is created with appropriate initial status

#### Scenario: Practitioner completes bulk-created draft submission
- **WHEN** a practitioner views a submission with TrangThaiDuyet = 'Nhap' created by an admin
- **THEN** they can upload evidence via FileMinhChungUrl
- **AND** submit the submission for approval (changes status to ChoDuyet)
- **AND** the NguoiNhap value remains the original admin who created it

#### Scenario: Backward compatibility with existing submissions
- **WHEN** viewing or processing submissions created before bulk enrollment feature
- **THEN** the system handles them identically to new submissions
- **AND** no migration or data changes are required for existing GhiNhanHoatDong records
