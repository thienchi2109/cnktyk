# API Routes Updated for New Schema ✅

## Summary

Successfully updated all API routes to match the new database schema after Migration 003.

## Files Updated

### 1. `src/app/api/submissions/route.ts`

**POST /api/submissions - Create Activity Submission**

**Changes:**
- Updated validation schema to include Migration 003 fields
- Removed obsolete fields (`VaiTro`, `ThoiGianBatDau`, `ThoiGianKetThuc`, `SoGio`, `GhiChu`)
- Added new fields:
  - `HinhThucCapNhatKienThucYKhoa` - Form of medical knowledge update
  - `ChiTietVaiTro` - Detailed role
  - `DonViToChuc` - Organizing unit
  - `NgayBatDau` - Activity start date
  - `NgayKetThuc` - Activity end date
  - `SoTiet` - Number of sessions
  - `SoGioTinChiQuyDoi` - Converted credit hours
  - `BangChungSoGiayChungNhan` - Certificate number
  - `GhiChuDuyet` - Approval notes

**Request Body Example:**
```json
{
  "MaNhanVien": "uuid",
  "TenHoatDong": "Hội thảo Y học lâm sàng 2024",
  "HinhThucCapNhatKienThucYKhoa": "Hội thảo khoa học",
  "ChiTietVaiTro": "Báo cáo viên",
  "DonViToChuc": "Bệnh viện Đa khoa Cần Thơ",
  "NgayBatDau": "2024-03-15",
  "NgayKetThuc": "2024-03-17",
  "SoTiet": 12,
  "SoGioTinChiQuyDoi": 5.5,
  "BangChungSoGiayChungNhan": "GCN-2024-001234",
  "FileMinhChungUrl": null
}
```

**GET /api/submissions - List Submissions**
- No changes needed (returns all fields from database)

### 2. `src/app/api/submissions/[id]/route.ts`

**GET /api/submissions/[id] - Get Submission Details**
- No changes needed (returns all fields from database)

**PUT /api/submissions/[id] - Approve/Reject Submission**
- Uses updated repository methods (`approveActivity`, `rejectActivity`)
- Now sets `NguoiDuyet` and `NgayDuyet` correctly

**DELETE /api/submissions/[id] - Delete Submission**
- No changes needed

### 3. `lib/db/repositories.ts`

**GhiNhanHoatDongRepository Updates:**

**`findByPractitioner()` method:**
```typescript
// Before:
ORDER BY "ThoiGianBatDau" DESC, "CreatedAt" DESC

// After:
ORDER BY "NgayBatDau" DESC NULLS LAST, "NgayGhiNhan" DESC
```

**`findPendingApprovals()` method:**
```typescript
// Before:
ORDER BY g."CreatedAt" ASC

// After:
ORDER BY g."NgayGhiNhan" ASC
```

**`approveActivity()` method:**
```typescript
// Before:
{
  TrangThaiDuyet: 'DaDuyet',
  ThoiGianDuyet: new Date(),
  GhiChu: comments,
}

// After:
{
  TrangThaiDuyet: 'DaDuyet',
  NgayDuyet: new Date(),
  NguoiDuyet: approverId,
  GhiChuDuyet: comments || null,
}
```

**`rejectActivity()` method:**
```typescript
// Before:
{
  TrangThaiDuyet: 'TuChoi',
  ThoiGianDuyet: new Date(),
  GhiChu: reason,
}

// After:
{
  TrangThaiDuyet: 'TuChoi',
  NgayDuyet: new Date(),
  NguoiDuyet: approverId,
  GhiChuDuyet: reason,
}
```

## Field Mapping Reference

### Submission Creation

| Frontend Field | Database Column | Type | Required |
|---------------|-----------------|------|----------|
| MaNhanVien | MaNhanVien | UUID | Yes |
| TenHoatDong | TenHoatDong | TEXT | Yes |
| HinhThucCapNhatKienThucYKhoa | HinhThucCapNhatKienThucYKhoa | TEXT | No |
| ChiTietVaiTro | ChiTietVaiTro | TEXT | No |
| DonViToChuc | DonViToChuc | TEXT | No |
| NgayBatDau | NgayBatDau | DATE | No |
| NgayKetThuc | NgayKetThuc | DATE | No |
| SoTiet | SoTiet | NUMERIC | No |
| SoGioTinChiQuyDoi | SoGioTinChiQuyDoi | NUMERIC | No |
| BangChungSoGiayChungNhan | BangChungSoGiayChungNhan | TEXT | No |
| FileMinhChungUrl | FileMinhChungUrl | TEXT | No |
| GhiChuDuyet | GhiChuDuyet | TEXT | No |

### Auto-Generated Fields

| Field | Generated By | When |
|-------|-------------|------|
| MaGhiNhan | Database (UUID) | On INSERT |
| NgayGhiNhan | Database (NOW()) | On INSERT |
| NguoiNhap | API (from session) | On INSERT |
| TrangThaiDuyet | API (default 'ChoDuyet') | On INSERT |
| NgayDuyet | API (on approval/rejection) | On UPDATE |
| NguoiDuyet | API (from session) | On UPDATE |

## API Response Format

### Submission Object

```typescript
{
  MaGhiNhan: string;
  MaNhanVien: string;
  MaDanhMuc: string | null;
  TenHoatDong: string;
  NgayGhiNhan: Date;
  FileMinhChungUrl: string | null;
  NguoiNhap: string;
  TrangThaiDuyet: 'ChoDuyet' | 'DaDuyet' | 'TuChoi';
  NgayDuyet: Date | null;
  NguoiDuyet: string | null;
  GhiChuDuyet: string | null;
  // Extended fields
  HinhThucCapNhatKienThucYKhoa: string | null;
  ChiTietVaiTro: string | null;
  DonViToChuc: string | null;
  NgayBatDau: Date | null;
  NgayKetThuc: Date | null;
  SoTiet: number | null;
  SoGioTinChiQuyDoi: number | null;
  BangChungSoGiayChungNhan: string | null;
  // Enriched data
  practitioner: {
    HoVaTen: string;
    SoCCHN: string;
    ChucDanh: string;
  };
  activityCatalog: {
    TenDanhMuc: string;
    LoaiHoatDong: string;
  } | null;
}
```

## Approval Workflow

### 1. Submit Activity
```
POST /api/submissions
→ Creates record with TrangThaiDuyet = 'ChoDuyet'
→ Sets NguoiNhap = current user ID
→ Sets NgayGhiNhan = NOW()
```

### 2. Approve Activity
```
PUT /api/submissions/[id]
Body: { action: 'approve', comments: '...' }
→ Updates TrangThaiDuyet = 'DaDuyet'
→ Sets NgayDuyet = NOW()
→ Sets NguoiDuyet = current user ID
→ Sets GhiChuDuyet = comments
```

### 3. Reject Activity
```
PUT /api/submissions/[id]
Body: { action: 'reject', reason: '...' }
→ Updates TrangThaiDuyet = 'TuChoi'
→ Sets NgayDuyet = NOW()
→ Sets NguoiDuyet = current user ID
→ Sets GhiChuDuyet = reason
```

## Testing Checklist

- [ ] Create activity submission with all new fields
- [ ] Create activity submission with minimal fields
- [ ] List submissions (practitioner view)
- [ ] List submissions (unit admin view)
- [ ] List submissions (DoH admin view)
- [ ] Get submission details
- [ ] Approve submission
- [ ] Reject submission
- [ ] Delete pending submission
- [ ] Verify NgayDuyet and NguoiDuyet are set on approval
- [ ] Verify GhiChuDuyet is saved correctly
- [ ] Test date validation (NgayKetThuc >= NgayBatDau)
- [ ] Test credit calculation with SoTiet

## Known Issues

- Temporary `as any` cast in submission creation due to TypeScript caching issue
- Will be resolved after TypeScript server restart or clean build

## Next Steps

1. ✅ API routes updated
2. ⏳ Update frontend forms to include new fields
3. ⏳ Update frontend display components
4. ⏳ Test complete submission workflow
5. ⏳ Test approval workflow
6. ⏳ Update bulk import to use new schema

## Related Documents

- [Schema Update Complete](.kiro/specs/compliance-management-platform/SCHEMA_UPDATE_COMPLETE.md)
- [Data Relationship Workflow](.kiro/specs/compliance-management-platform/DATA_RELATIONSHIP_WORKFLOW.md)
- [Migration 003 Summary](.kiro/specs/compliance-management-platform/MIGRATION_003_SUMMARY.md)
